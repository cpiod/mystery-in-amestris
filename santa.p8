pico-8 cartridge // http://www.pico-8.com
version 29
__lua__
-- noname secret santa
-- cpiod

function _init()
-- o:
-- 0=up, 1=down, 2=left, 3=right
 p={x=9*8,y=4*8,o=1,f=false}
 p.ox=p.x
 p.oy=p.y
 
-- mode:
-- 1: move
-- 2: dialog
 mode=1
 
 -- npc number:
 -- 1=mustang
 -- 2=postman
 -- 3=apprentice
 npc={{id=1,x=10,y=3},{id=2,x=8,y=6,f=true},{id=3,x=5,y=6}}
	palt(0,false)
	palt(14,true)
end

function _update60()
 if mode==1 then
  update_move()
 elseif mode==2 then
  update_diag()
 end
end

function update_diag()
 if(btnp(‚¨ÜÔ∏è) and slct>1) slct-=1
 if(btnp(‚¨áÔ∏è) and slct<#a) slct+=1
 if btnp(üÖæÔ∏è) then
  nb=path[slct]
  if(nb==0 or nb==nil) mode=1 else change_dial()
 end
end

-- si path>1 et answer!=path -> add bye
-- si path==1 et pas answer -> no answer
-- si path==0 -> bye/leave

function change_dial()
 slct=1
 if dall[chat]==nil then
  -- nothing to say
  mode=1
 else
  d,a,path=dall[chat][nb],aall[chat][nb],pall[chat][nb]
  a=a or {}
  path=path or {}
  if(#path>1 and #a!=#path) add(a,"bye")
  if(#path==0) a={"bye"}
 end
end

function start_dial(id)
 mode=2
 chat=id
 nb=1
 change_dial()
end

function update_move()
 if p.x==p.ox and p.y==p.oy then
  -- moving
	 local x,y=p.x,p.y
	 if(btn(‚¨ÜÔ∏è)) p.o=0 y-=8
	 if(btn(‚¨áÔ∏è)) p.o=1 y+=8
	 if(btn(‚û°Ô∏è)) p.o=3 x+=8 p.f=false
	 if(btn(‚¨ÖÔ∏è)) p.o=2 x-=8 p.f=true
	 if(x!=p.x)y=p.y
	 -- check collision
	 if(fget(mget(x/8,y/8),0)) x,y=p.x,p.y
	 for n in all(npc) do
	 -- npc in path: stop moving, start chatting
	  if(n.x==x/8 and n.y==y/8) x,y=p.x,p.y start_dial(n.id)
	 end
	 p.ox,p.oy=x,y
 else
  if(p.x<p.ox) p.x+=1
  if(p.x>p.ox) p.x-=1
  if(p.y<p.oy) p.y+=1
  if(p.y>p.oy) p.y-=1
 end
end
-->8
--dialog system
slct=1

faces={80,83,86,89}
names={"rOY mUSTANG","aMELIA sMITH","oWEN lOCKE","aNNA bERKELEY"}
-- nb: text id
-- d=text, list of lines
-- a=answers, list of lines
-- s=current selected answers
function cnt(t)
 local i=0
 for n=1,#t do
  if(sub(t,n,n)=="\n") i+=1
 end
 return i
end

function prt_dial()
 local i=cnt(d)
 for t in all(a) do
  i+=cnt(t)
 end
 local maxy=8+6*(i+#a)
 deltay=98-maxy
 spr(faces[chat],camx+5,camy+deltay,3,3)
 for i=-1,1 do
  for j=-1,1 do
   print(names[chat],camx+30+i,camy+deltay+18+j,0)
  end
 end
 print(names[chat],camx+30,camy+deltay+18,6)
 rectfill(3+camx,24+camy+deltay,125+camx,maxy+camy+24+deltay,6) rect(3+camx,24+camy+deltay,125+camx,maxy+camy+24+deltay,7)
 cursor(5+camx,26+camy+deltay,0)
 print(d)
 for i=1,#a do
  if i==slct then
   color(12)
   print(">"..a[i])
  else
   color(13)
   print(" "..a[i])
  end
 end
end
-->8
-- text

-- prolog
dpro={"my name is anna berkeley, but\nas a state alchemist i am\nknown as the mud alchemist.","page 2"}
apro={}
ppro={{2}}

dmust={"first !\nblabla","you said yes","you said no","and so and so"}
dall={dmust,dpro,dpro,dpro}
amust={{"yes","no"},{"again"},{},{"why?"}}
aall={amust,apro,apro,apro}
pmust={{2,3,0},{1,0},{4},{1}}
pall={pmust,ppro,ppro,ppro}
-->8
--draw


function _draw()
 camx=p.x-60
 camy=p.y-60
 camera(camx,camy)
 cls(0)
 fillp(0)
	
	map()
	local done=false
	for n in all(npc) do
	 if not done and p.y<=n.y*8 then
	  done=true
	 	spr(9,p.x,p.y-10,1,2,p.f)
	 end
	 spr(n.id+5,n.x*8,n.y*8-10,1,2,n.f!=nil)
	end
	
	if(mode==2)	prt_dial(d,a)
end

__gfx__
00000000ee000eeeee1111eeee000eeeee999eee00000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000000000000000000000000000
00000000ee0f0eeeeeafaeeeee0f0eeeee9f9eee00000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000000000000000000000000000
00000000eefffeeeeefffeeeeefffeeeee9f9eee00000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000000000000000000000000000
00000000eea61eeeee1ddeeeee4949eeee888eee00000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000000000000000000000000000
00000000e71617eeefd1dfeeef222feeef888fee00000000eeeeeeeeee111eeeeeeeeeeeeeeeee9e000000000000000000000000000000000000000000000000
00000000ee666eeeeedd1eeeee222eeeee888eee00000000ee0000eee111111eeeeeeeeeee9999ee000000000000000000000000000000000000000000000000
00000000ee1e1eeeeededeeeee2e2eeeee8e8eee00000000e000000eeaaaaaaeee0000eee999999e000000000000000000000000000000000000000000000000
00000000ee0e0eeeee0e0eeeee0e0eeeee0e0eee00000000e0000feeeaaaafeaee0fffeee9999fee000000000000000000000000000000000000000000000000
ee999eee0000000000000000000000000000000000000000e000ffeeeeaaffeeeeffffeee999ffee000000000000000000000000000000000000000000000000
ee9f9eee0000000000000000000000000000000000000000eeffffeeeeffffeeeeffffeeee99ffee000000000000000000000000000000000000000000000000
ee9f9eee0000000000000000000000000000000000000000eefffeeeeefffeeeeefffeeeee99feee000000000000000000000000000000000000000000000000
ee111eee0000000000000000000000000000000000000000ee1111eeeeddddeee49494eeee9111ee000000000000000000000000000000000000000000000000
ef111fee0000000000000000000000000000000000000000ee1111eeeeddd9eee92222eeee1111ee000000000000000000000000000000000000000000000000
ee111eee0000000000000000000000000000000000000000ee1171eeeeddfdeeee22f2eeee11f1ee000000000000000000000000000000000000000000000000
ee1e1eee0000000000000000000000000000000000000000ee1111eeeeddddeeee2222eeee1111ee000000000000000000000000000000000000000000000000
ee0e0eee0000000000000000000000000000000000000000ee00100eee00d00eee00200eee00100e000000000000000000000000000000000000000000000000
65555555666666667777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
65555555666776666666666666666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
655555556677776666666666617cccc6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
65555555666776666666666667cccc76000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
65555555677666666666666661ccc7c6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
65555555777767766666666661117116000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
65555555677677776666666666666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6666666666666776dddddddddddddddd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
65655555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
56555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
65655555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55556565000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555655000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55556565000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
eeeee77777eeeeeeeeeeeeeeeeeeee7777777eeeeeeeeeeeeeeeeee77777eeeeeeeeeeeeeeeeeeeeeeeeee77eeeeeeee00000000000000000000000000000000
eeee7000007eeeeeeeeeeeeeeeeee711111117eeeeeeeeeeeeeeee7000007eeeeeeeeeeeeeeeeee7777777997eeeeeee00000000000000000000000000000000
eee700000007eeeee8eeeeeeeeee71111111117777eeeeeeeeeee7000ff007eeeeeeeeeeeeeeee799999997797eeeeee00000000000000000000000000000000
ee70000000007ee8e98eeeeeeeee711111111111117eeeeeeeeee700fffff07eeeeeeeeeeeeee79999fff9977eeeeeee00000000000000000000000000000000
e70000000f0007e89988eeeeeeee7aaaaaaaaa7777eeeeeeeeee700ff5ff5f7eeeeeeeeeeeee79999ffff997eeeeeeee00000000000000000000000000000000
e700000ffff0007e89998eeeeeee7aaaaafffaa7eeeeeeeeeeee700fffffff7eeeeeeeeeeee799999fffff997eeeeeee00000000000000000000000000000000
700000f5ff5f07ee89998eeeeeee7aafffafffa77777777eeeee700ff5ffff7eeeeeeeeeeee79999ffffff997eeeeeee00000000000000000000000000000000
e77000ffffff7eeee899eeeeeeee7aaffcafcf7a66666667eeeee70fff55f7e777777eeeeee79999ffffff997eeeeeee00000000000000000000000000000000
ee700fffffff7eeeee78eeeeeeee7aafffffff7767888767eeeeee77ffff7e71c11c17eeee79999fffffff997eeeeeee00000000000000000000000000000000
e7077fff55f7eeee7e77eeeeeee7aafff5ffff7767787767eeeee74449944771c11c17eeee79999ffffff9997eeeeeee00000000000000000000000000000000
ee77666fff7eeeee7e7777eeeeee7a7fff55f7e766666667eeee799444994441c11c17eeee799999ffff99997eeeeeee00000000000000000000000000000000
ee7611606667eeee777877eeeeeee7e7ffff7eee77ffff7eeee799994499445655657eeeee799999ff9999997eeeeeee00000000000000000000000000000000
e70aaa6161167eee7787877eeeee77777ff7777ee7ffff7eee7449994449945655657eeeee799999ff099997eeeeeeee00000000000000000000000000000000
70a101a1111107707787877eeee71111ffff1117ee7ff7eeee7444222200225655657eeeeee799990ff09997eeeeeeee00000000000000000000000000000000
7011101a11111001077877eeee71ddd1ffff1dd1777ff7eeee799922209222889807eeeeeeee7999100199907eeeeeee00000000000000000000000000000000
701111001111101107777eeee71dddd11fff11dd117ff7eee74492220222898898207eeeeee709911111091107eeeeee00000000000000000000000000000000
7a011111001161111077eeee71dddd1dd111dd1ddd1ff7eee70422220292898898207eeeee70111111061111107eeeee00000000000000000000000000000000
7a00111111001611110eeeee71ddd1dddd1dddd1dd1ff7ee70220222022223b33b3207eee7011111101161101107eeee00000000000000000000000000000000
e7a1001111111611660eeeee7f111ddddd1ddddd11fff7ee70222002029223b33b3207ee70111666011116660107eeee00000000000000000000000000000000
e70aaa0011111166eeeeeeee7fff1dddddd1d99d1fff7eee70222220000223b33b32207e701111106111611601107eee00000000000000000000000000000000
e701111100110007eeeeeeee7fff1dddddd1d99d1777eeeee70022222220ffffff02207e701111101616111610107eee00000000000000000000000000000000
e701111161006107eeeeeeee7fff1d1dddd1dddd17eeeeeeee7700022220ffffff02207e701101101161111610107eee00000000000000000000000000000000
e701111161116107eeeeeeee7fff1dd11d1ddd117eeeeeeeeeee70200002222fff7007ee701101101111111610107eee00000000000000000000000000000000
e701111161116107eeeeeeeee7fff1dddd1dddd17eeeeeeeeeee70220222222077e77eee701101011111111610107eee00000000000000000000000000000000
__gff__
0100000000000000000000000000000000000000000000000000000000000000000001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000022222322222222222223222200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000020202020202020303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000020202020202020303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000020202020202020303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000020202020202020303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000020202020202020303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000020202020202020303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
